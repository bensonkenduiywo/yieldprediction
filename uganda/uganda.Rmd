---
title: "Uganda MAIZE Forescasts"
author: "Dr. -Ing. MISK Benson Kenduiywo"
date: '2022-06-30'
output: html_document
---

```{r, global_options, tidy = TRUE, echo=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60))

```


## RHEAS simulated yields

Load and aggregate RHEAS simulated Leaf Area Index (LAI), Water stress and Grain Weight Average Dry (GWAD) across different ensembles. Extract year from dates (we will use harvest year).

```{r rh1, echo=FALSE}
rm(list = ls(all=TRUE))
unlink(".RData")
root <- "D:/RCMRD/Data/Yields/"
tt <- read.csv(paste0(root, "RHEAS/uganda_dssatTable_1990_2022.csv"), stringsAsFactors =  FALSE)
tt$harvest <- as.Date(tt$harvest)
tt$planting <- as.Date(tt$planting)
tt$date <- format(tt$harvest, format = "%Y")
names(tt)[3] <- "District"
tt$District <- toupper(tt$District)
```

## Production forecast and RHEAS metrics aggregagation

Aggregate RHEAS production forecasts and metrics with respect to Districts maize growing calendar. 

There two maize growing seasons in Uganda [(Epule et. al. 2021)](https://link.springer.com/article/10.1007/s42452-021-04532-5):
1) Season 1: sowing in February and March, growing in April and May while harvesting occurs in June and July.
2) Season 2: sowing in September and October, growing in November and harvesting in December. 

Some ares in the north has a uni-modal (mono-modal) or one growing season. Sowing occurs in April and May, growing in June and July and harvesting in August and September [see](https://link.springer.com/article/10.1007/s42452-021-04532-5/figures/1).

In this we will consider two season. 

So we will aggregate the metrics and yield forecast per district with this condition using the function `RH_metrics`.

```{r rh2, echo=F}
RH_metrics <- function(rh, sStart, sEnd, season){
  rh <- subset(rh, format(as.Date(rh$planting), "%m") >= sStart & format(as.Date(rh$harvest), "%m") <= sEnd)
  rh$Season <- season
  rh <- aggregate(rh[,c("wsgd","lai","gwad")], rh[,c("District","date", "Season")], mean, na.rm=T)
  return(rh)
}

rh1 <- RH_metrics(tt, sStart ="02", sEnd = "08", "1")
rh2 <- RH_metrics(tt, sStart ="09", sEnd = "12", "2")
rh <- rbind(rh1,rh2)

```

Convert RHEAS yields from kg/ha to MT/ha.

```{r rh3, echo=FALSE}
rh$gwad <- rh$gwad/1000
```


## Visualization

Add shapefile for visualization.

```{r, v1, echo=F}
library(raster)
filename <- "D:/Adm data/Uganda/uga_admbnda_adm2_ubos_20200824.shp"
uga <- shapefile(filename)
names(uga)[3] <- "District"
uga$District <- toupper(uga$District)
```


Check and format District names to be consistent in both the RHEAS and administrative boundaries.

```{r v2, echo=F}
c <- sort(unique(uga$District))
c[!c %in% sort(unique(rh$District))]
```

 Merge RHEAS and Admin data.
 
```{r v3, echo=F}
uga <-  merge(uga[,"District"], rh, by = "District", duplicateGeoms=TRUE)
shapefile(uga[,c("District", "wsgd", "lai","gwad", "date","Season")], "Uganda_Maize_Forecasts.shp",overwrite=T)

```


### First Season

Visualize RHEAS predicted yields spatially for *season 1*. *NOTE: Ignore yields over the lake area*.

```{r v4, echo=F}
library(tmap)
library(mapview)
uga.p  <- uga
year <- 2022
uga.p <- subset(uga.p, date==year & Season==1)
tmap_mode("view")
map_a <- tm_shape(uga.p, name="Average yield (MT/ha) per District") +
  tm_polygons(c("gwad", "lai", "wsgd"),  title=c(paste(year, " Yield (MT/ha)"), "Leaf Area Index", "Water Stress")) +
  tm_facets(sync = TRUE, ncol = 2, nrow=2) +
  tm_text("District", size = 0.5)+
  tm_layout(title.size =5, panel.label.size=6)+
  tm_format("World")
map_a

#lf <- tmap_leaflet(map_a)
#mapshot(lf, file = "D:/RCMRD/code/UG_Yields_2022_MODIS.png")

```


### Annual Seasonal Trends

Visualize trends for the last 5 years.
 
```{r bb1, echo=FALSE}
library(ggplot2)
temp <- rh[rh$date > 2009,]
p <- ggplot(temp, aes(x = date, y = gwad))

p <- p + geom_boxplot(
  aes(fill = Season),
  position = position_dodge(0.9) 
  ) +
  scale_fill_manual(values = c("#999999", "#E69F00"))+
  ggtitle("Annual Seasonal  Maize Yield")+
  labs(y = "Yield (MT/ha)", x = "Year")
p

```
 
The first season seems to do well on average.


### Second Season

Now lets how  *season 2* looks spatially

```{r v5, echo=F}
uga.p  <- uga
uga.p <- subset(uga.p, date==year & Season==2)
tmap_mode("view")
map_a <- tm_shape(uga.p, name="Average yield (MT/ha) per District") +
  tm_polygons(c("gwad", "lai", "wsgd"),  title=c(paste(year, " Yield (MT/ha)"), "Leaf Area Index", "Water Stress")) +
  tm_facets(sync = TRUE, ncol = 2, nrow=2) +
  tm_text("District", size = 0.5)+
  tm_layout(title.size =5, panel.label.size=6)+
  tm_format("World")
map_a
```

