---
title: "Tanzania Maize Yield Forecast"
author: "Dr. -Ing. MISK Benson Kenduiywo"
csl: "apa-6th-edition.csl"
output: 
   html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60))
opts_knit$set(global.par = TRUE)
```

## RHEAS forecasts

Load and aggregate RHEAS simulated Leaf Area Index (LAI), Water stress and Grain Weight Average Dry (GWAD) across different ensembles. Extract year from dates (we will use harvest year).

```{r rh1, echo=FALSE, message=F}
rm(list = ls(all=TRUE))
unlink(".RData")
root <- "D:/RCMRD/Data/Yields/"
tt <- read.csv(paste0(root, "RHEAS/tanzania_tamsat_25km_dssatTable_2000_2022_100kg.csv"), stringsAsFactors =  FALSE)
tt$harvest <- as.Date(tt$harvest)
tt$planting <- as.Date(tt$planting)
tt$date <- format(tt$harvest, format = "%Y")
names(tt)[3] <- "Region"
tt$Region <- toupper(tt$Region)
```


## Metrics aggregagation

Aggregate RHEAS production forecasts and metrics with respect to Districts maize growing calendar. 

We assume three maize growing seasons in Tanzania:
1) Season 1: OND (SRSD) October -- February.
2) Season 2: MAM March -- September. 
3) Season 3: Long Rain (LR) November -- April 

So we will aggregate the metrics and yield forecast per district with this condition using the function `RH_metrics`.

```{r rh2, echo=F, message=F}
RH_metrics <- function(rh, sStart, sEnd, season){
  rh <- subset(rh, format(as.Date(rh$planting), "%m") >= sStart & format(as.Date(rh$harvest), "%m") <= sEnd)
  rh$Season <- season
  rh <- aggregate(rh[,c("wsgd","lai","gwad"), drop=FALSE], rh[,c("Region","date", "Season"), drop=FALSE], mean, na.rm=T)
  return(rh)
}

rh1 <- RH_metrics(tt, sStart ="10", sEnd = "04", "OND")
rh2 <- RH_metrics(tt, sStart ="02", sEnd = "09", "MAM")
#rh3 <- RH_metrics(tt, sStart ="11", sEnd = "04", "LR")

rh <- do.call(rbind, list(rh1, rh2))

```

Convert RHEAS yields from kg/ha to MT/ha.

```{r rh3, echo=FALSE}
rh$gwad <- rh$gwad/1000
```


## Visualization

Add shapefile for visualization.

```{r, v1, echo=F, message=F}
library(raster)
filename <- "D:/Adm data/Tanzania/gadm36_TZA_1.shp"
tza <- shapefile(filename)
names(tza)[4] <- "Region"
tza$Region <- toupper(tza$Region)
```


Check and format Region names to be consistent in both the RHEAS and administrative boundaries. Here we check which regions are mission from RHEAS predictions.

```{r v2, echo=F, message=F}
c <- sort(unique(tza$Region))
c[!c %in% sort(unique(rh$Region))]
```

 Merge RHEAS and Admin data.
 
```{r v3, echo=F, message=F}
year <- 2022
tza <-  merge(tza[,"Region"], rh[rh$date==year,], by = "Region", duplicateGeoms=TRUE)
path <- "D:/RCMRD/Code/yieldprediction"
#shapefile(tza[,c("Region", "wsgd", "lai","gwad", "date","Season")], paste0(path,"/tanzania/tanzania_Maize_Forecasts.shp"),overwrite=T)

```


### First Season (OND)

Visualize RHEAS predicted yields spatially for *season 1*. *NOTE: Ignore yields over the lake area*.

```{r v4, echo=F, message=F}
library(tmap)
library(mapview)
tza.p <- subset(tza, Season=="OND")
tmap_mode("view")
map_a <- tm_shape(tza.p, name="Average yield (MT/ha) per Region") +
  tm_polygons(col=c("gwad", "lai"),  n=5, title=c(paste(year, " Yield (MT/ha)"), "Leaf Area Index")) +
  tm_facets(sync = TRUE, ncol = 2, nrow=1) +
  #tm_text("District", size = 0.75)+
  tm_layout(title.size =5, panel.label.size=6)+
  tm_format("World")
map_a

```


### Second Season (MAM)

Now lets how  *season 2* looks spatially

```{r v5, echo=F , message=F}
library(tmap)
library(mapview)
tza.1  <- tza
tza.1 <- subset(tza.1, date==year & Season=="MAM")
tmap_mode("view")
map_b <- tm_shape(tza.1, name="Average yield (MT/ha) per District") +
  tm_polygons(col=c("gwad", "lai"),  n=5,  title=c(paste(year, " Yield (MT/ha)"), "Leaf Area Index"),n=5) +
  tm_facets(sync = TRUE, ncol = 2, nrow=1) +
  #tm_text("District", size = 0.75)+
  tm_layout(title.size =5, panel.label.size=6)+
  tm_format("World")
map_b

```


## Annual Seasonal Trends

Visualize trends for the last 5 years.
 
```{r bb1, echo=FALSE}
library(ggplot2)
temp <- rh[rh$date > 2009,]
p <- ggplot(temp, aes(x = date, y = gwad))

p <- p + geom_boxplot(
  aes(fill = Season),
  position = position_dodge(0.9) 
  ) +
  scale_fill_manual(values = c("#999999", "#E69F00", "green"))+
  ggtitle("Annual Seasonal  Maize Yield")+
  labs(y = "Yield (MT/ha)", x = "Year")
p

```
 